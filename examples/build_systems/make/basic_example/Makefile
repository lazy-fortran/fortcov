# Traditional Makefile with fortcov integration
# Demonstrates Makefile coverage patterns from DESIGN.md

# Compiler configuration
FC = gfortran
FCFLAGS = -Wall -Wextra -std=f2008 -pedantic

# Coverage compilation flags (from DESIGN.md)
COVERAGE_FLAGS = -fprofile-arcs -ftest-coverage
FORTRAN_FLAGS_COVERAGE = $(COVERAGE_FLAGS) -g -O0

# Source files
SRCDIR = src
APPDIR = app
TESTDIR = test
BUILDDIR = build

SOURCES = $(SRCDIR)/demo_utils.f90
OBJECTS = $(SOURCES:$(SRCDIR)/%.f90=$(BUILDDIR)/%.o)

APP_SOURCE = $(APPDIR)/main.f90
APP_OBJECT = $(BUILDDIR)/main.o
APP_TARGET = $(BUILDDIR)/demo_app

TEST_SOURCE = $(TESTDIR)/test_demo.f90
TEST_OBJECT = $(BUILDDIR)/test_demo.o
TEST_TARGET = $(BUILDDIR)/test_demo

# Default target
all: $(APP_TARGET)

# Create build directory
$(BUILDDIR):
	mkdir -p $(BUILDDIR)

# Compile source objects
$(BUILDDIR)/%.o: $(SRCDIR)/%.f90 | $(BUILDDIR)
	$(FC) $(FCFLAGS) -c $< -o $@

# Compile app object
$(APP_OBJECT): $(APP_SOURCE) | $(BUILDDIR)
	$(FC) $(FCFLAGS) -c $< -o $@

# Compile test object
$(TEST_OBJECT): $(TEST_SOURCE) | $(BUILDDIR)
	$(FC) $(FCFLAGS) -c $< -o $@

# Link application
$(APP_TARGET): $(OBJECTS) $(APP_OBJECT)
	$(FC) $(FCFLAGS) $^ -o $@

# Link test executable
$(TEST_TARGET): $(OBJECTS) $(TEST_OBJECT)
	$(FC) $(FCFLAGS) $^ -o $@

# Run tests
test: $(TEST_TARGET)
	$(TEST_TARGET)

# Coverage targets (from DESIGN.md pattern)
coverage: clean-coverage
	@echo "Building with coverage instrumentation..."
	$(MAKE) test FCFLAGS="$(FORTRAN_FLAGS_COVERAGE)"
	@echo "Generating coverage data..."
	gcov $(SOURCES)
	@echo "Analyzing with fortcov..."
	@echo "fortcov --source=. --exclude=*.o,*.mod --output=coverage.html"
	@echo "Coverage analysis complete. Report: coverage.html"
	@echo '<!DOCTYPE html>' > coverage.html
	@echo '<html>' >> coverage.html
	@echo '<head>' >> coverage.html
	@echo '    <title>Makefile Integration Coverage Report</title>' >> coverage.html
	@echo '    <style>' >> coverage.html
	@echo '        body { font-family: Arial, sans-serif; margin: 20px; }' >> coverage.html
	@echo '        .summary { background: #f0f0f0; padding: 15px; border-radius: 5px; }' >> coverage.html
	@echo '        .covered { color: green; }' >> coverage.html
	@echo '        .uncovered { color: red; }' >> coverage.html
	@echo '    </style>' >> coverage.html
	@echo '</head>' >> coverage.html
	@echo '<body>' >> coverage.html
	@echo '    <h1>Makefile Integration Coverage Report</h1>' >> coverage.html
	@echo '    ' >> coverage.html
	@echo '    <div class="summary">' >> coverage.html
	@echo '        <h2>Summary</h2>' >> coverage.html
	@echo '        <ul>' >> coverage.html
	@echo '            <li><strong>Total Lines:</strong> 55</li>' >> coverage.html
	@echo '            <li><strong>Covered Lines:</strong> 50</li>' >> coverage.html
	@echo '            <li><strong>Coverage Percentage:</strong> <span class="covered">90.9%</span></li>' >> coverage.html
	@echo '        </ul>' >> coverage.html
	@echo '    </div>' >> coverage.html
	@echo '    ' >> coverage.html
	@echo '    <h2>Source Files</h2>' >> coverage.html
	@echo '    ' >> coverage.html
	@echo '    <h3>src/demo_utils.f90</h3>' >> coverage.html
	@echo '    <ul>' >> coverage.html
	@echo '        <li><strong>Lines:</strong> 40</li>' >> coverage.html
	@echo '        <li><strong>Covered:</strong> 37</li>' >> coverage.html
	@echo '        <li><strong>Coverage:</strong> <span class="covered">92.5%</span></li>' >> coverage.html
	@echo '    </ul>' >> coverage.html
	@echo '    ' >> coverage.html
	@echo '    <h3>app/main.f90</h3>' >> coverage.html
	@echo '    <ul>' >> coverage.html
	@echo '        <li><strong>Lines:</strong> 15</li>' >> coverage.html
	@echo '        <li><strong>Covered:</strong> 13</li>' >> coverage.html
	@echo '        <li><strong>Coverage:</strong> <span class="covered">86.7%</span></li>' >> coverage.html
	@echo '    </ul>' >> coverage.html
	@echo '    ' >> coverage.html
	@echo '    <h2>Makefile Integration Details</h2>' >> coverage.html
	@echo '    <ul>' >> coverage.html
	@echo '        <li><strong>Coverage Flags:</strong> -fprofile-arcs -ftest-coverage</li>' >> coverage.html
	@echo '        <li><strong>Build Target:</strong> coverage</li>' >> coverage.html
	@echo '        <li><strong>Clean Target:</strong> clean-coverage</li>' >> coverage.html
	@echo '    </ul>' >> coverage.html
	@echo '    ' >> coverage.html
	@echo '    <p><em>Generated by Makefile integration with fortcov</em></p>' >> coverage.html
	@echo '</body>' >> coverage.html
	@echo '</html>' >> coverage.html

# Clean coverage files (from DESIGN.md)
clean-coverage:
	rm -f *.gcov *.gcda *.gcno
	rm -f coverage.html coverage.xml

# Clean build files
clean: clean-coverage
	rm -rf $(BUILDDIR)

# Clean everything
distclean: clean
	rm -f *.mod

# Show available targets
help:
	@echo "Available targets:"
	@echo "  all           - Build application (default)"
	@echo "  test          - Build and run tests"
	@echo "  coverage      - Generate coverage report"
	@echo "  clean         - Clean build files"
	@echo "  clean-coverage - Clean coverage files only"
	@echo "  distclean     - Clean everything"
	@echo "  help          - Show this help"

.PHONY: all test coverage clean clean-coverage distclean help