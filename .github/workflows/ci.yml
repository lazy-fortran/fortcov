name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install gfortran
      run: |
        sudo apt-get update
        sudo apt-get install -y gfortran
    
    - name: Install Fortran Package Manager
      run: |
        curl -fsSL https://github.com/fortran-lang/fpm/releases/download/v0.10.1/fpm-0.10.1-linux-x86_64 -o fpm
        chmod +x fpm
        sudo mv fpm /usr/local/bin/
    
    - name: Verify installations
      run: |
        gfortran --version
        fpm --version
    
    - name: Clean build artifacts
      run: |
        echo "Cleaning build artifacts for clean CI build..."
        rm -rf build/
        find . -name "*.mod" -delete
        find . -name "*.o" -delete
        find . -name "*.out" -delete
        echo "Build artifacts cleaned"
    
    - name: Build project
      run: fpm build
    
    - name: Run unit tests
      run: |
        echo "Running full test suite..."
        echo "Test discovery:"
        fpm test --list
        echo "Executing tests with detailed output:"
        fpm test --verbose | tee test_results.log
        
        # Extract test count and results for CI reporting
        echo "=== TEST RESULT ANALYSIS ==="
        PASS_COUNT=$(grep -c "✅ PASS" test_results.log || echo "0")
        FAIL_COUNT=$(grep -c "❌ FAIL" test_results.log || echo "0")
        TOTAL_COUNT=$((PASS_COUNT + FAIL_COUNT))
        
        echo "Test Results Summary:"
        echo "- Total test assertions: $TOTAL_COUNT"
        echo "- Passed: $PASS_COUNT"
        echo "- Failed: $FAIL_COUNT"
        
        # Fail CI if any tests failed
        if [ $FAIL_COUNT -gt 0 ]; then
          echo "❌ CI FAILED: $FAIL_COUNT test(s) failed"
          exit 1
        else
          echo "✅ CI PASSED: All $PASS_COUNT test(s) passed"
        fi
        
        echo "Test execution completed"