name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install gfortran
      run: |
        sudo apt-get update
        sudo apt-get install -y gfortran
    
    - name: Install Fortran Package Manager
      run: |
        curl -fsSL https://github.com/fortran-lang/fpm/releases/download/v0.10.1/fpm-0.10.1-linux-x86_64 -o fpm
        chmod +x fpm
        sudo mv fpm /usr/local/bin/
    
    - name: Verify installations
      run: |
        gfortran --version
        fpm --version
    
    - name: Clean build artifacts
      run: |
        echo "Cleaning build artifacts for clean CI build..."
        rm -rf build/
        find . -name "*.mod" -delete
        find . -name "*.o" -delete
        find . -name "*.out" -delete
        echo "Build artifacts cleaned"
    
    - name: Build project (once)
      run: fpm build --profile release
    
    - name: Run minimal unit tests (guarded, per-test 45s)
      env:
        RUNNING_TESTS: "1"   # Ensure in-test guard is active to avoid recursion
        FPM_BACKTRACE: "0"
      run: |
        set -e
        tests=( \
          cli_flags_rejection_minimal \
          engine_delegation_minimal \
        )
        for t in "${tests[@]}"; do
          echo "::group::Running test: $t"
          timeout -k 5 45 fpm test --profile release --target "$t" --verbose
          echo "::endgroup::"
        done
