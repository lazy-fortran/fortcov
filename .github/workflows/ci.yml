name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install gfortran
      run: |
        sudo apt-get update
        sudo apt-get install -y gfortran
    
    - name: Install Fortran Package Manager
      run: |
        curl -fsSL https://github.com/fortran-lang/fpm/releases/download/v0.10.1/fpm-0.10.1-linux-x86_64 -o fpm
        chmod +x fpm
        sudo mv fpm /usr/local/bin/
    
    - name: Verify installations
      run: |
        gfortran --version
        fpm --version
    
    - name: Clean build artifacts
      run: |
        echo "Cleaning build artifacts for clean CI build..."
        rm -rf build/
        find . -name "*.mod" -delete
        find . -name "*.o" -delete
        find . -name "*.out" -delete
        echo "Build artifacts cleaned"
    
    - name: Build project
      run: fpm build
    
    - name: Run unit tests
      run: |
        echo "Running unit tests with CI exclusions..."
        echo "Using run_ci_tests.sh to exclude problematic tests"
        
        # Use the project's CI test runner which excludes problematic tests
        ./run_ci_tests.sh
        
    - name: Verify CI hygiene
      run: |
        echo "Verifying CI hygiene - checking for test artifacts..."
        
        # Run hygiene verification
        if ./scripts/ci_hygiene_cleanup.sh; then
          echo "✅ CI Hygiene: Project root clean"
        else
          echo "❌ CI Hygiene: Artifacts found in project root"
          echo "Listing all artifacts:"
          find . -maxdepth 1 \( -name "test_infra_*" -o -name "*_test_*.log" \) 2>/dev/null || true
          exit 1
        fi