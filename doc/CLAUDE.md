# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

fortcov is a coverage analysis tool for Fortran code that processes coverage data generated by gfortran with `-fprofile-arcs -ftest-coverage` flags. The goal is to create an MVP that produces Markdown reports with coverage percentages, similar to lcov and gcovr but specifically tailored for Fortran projects.

## Current Implementation Status

### Completed Components

1. **Foundation Layer** âœ…
   - `coverage_model.f90`: Complete data model with types for lines, branches, functions, and files
   - `string_utils.f90`: String manipulation utilities 
   - `file_utils.f90`: File system operations

2. **Abstraction Layer** âœ…
   - `coverage_parser.f90`: Abstract interface and gcov parser implementation
   - `coverage_reporter.f90`: Abstract reporter interface

3. **Parser Implementation** âœ…
   - Handles endianness, function metadata, line mappings, and execution counters
   - Includes fallback to gcov text output parsing

4. **Analysis Layer** âœ…
   - `coverage_statistics.f90`: Coverage metric calculations
   
5. **Reporter Implementation** âœ…
   - `markdown_reporter.f90`: Markdown table generation with coverage percentages

### Work in Progress

- Main application (`app/main.f90`): Currently just a hello world placeholder
- CLI interface: Not yet implemented
- Configuration module: Not yet implemented
- Integration with actual gcov files: Needs real-world testing

## Build and Test Commands

```bash
# Build the project
fpm build

# Build with coverage flags
fpm build --flag "-fprofile-arcs -ftest-coverage"

# Run tests
fpm test

# Run tests with coverage
fpm test --flag "-fprofile-arcs -ftest-coverage"

# Clean build artifacts (preserving necessary files)
fpm clean --skip

# Run the main application
fpm run
```

## CRITICAL: Fork Bomb Prevention

**ðŸš¨ MANDATORY SAFETY RULES - NEVER VIOLATE:**

1. **NO TEST-WITHIN-TEST CALLS**:
   - Tests MUST NEVER call `fpm test` (causes infinite recursion)
   - Shell scripts in test/ MUST NOT execute the test runner
   - Any test calling the test runner creates a fork bomb

2. **FORK BOMB DETECTION**:
   - Any file containing `execute_command_line` + `fpm test` is a fork bomb
   - Shell scripts calling `fpm test --flag` are fork bombs
   - Tests running full test suite within test suite are fork bombs

3. **PREVENTION MEASURES**:
   - Fork bomb files are disabled by .FORK_BOMB_DISABLED suffix
   - Test runners must NOT invoke themselves recursively
   - Integration tests should test individual components, not full suite

4. **SAFETY VALIDATION**:
   - Before any `fpm test` run, scan for fork bomb patterns
   - Disabled files: test_readme_gcov_workflow.sh.FORK_BOMB_DISABLED
   - Disabled files: test_documentation_commands_issue_232.sh.FORK_BOMB_DISABLED
   - Disabled files: test_readme_executable_validation.sh.FORK_BOMB_DISABLED
   - Disabled files: test_issue_260_comprehensive.sh.FORK_BOMB_DISABLED

**VIOLATION OF THESE RULES = SYSTEM CRASH**

## Architecture and Structure

The project uses the Fortran Package Manager (FPM) structure:

- `src/` - Core library modules for coverage analysis
  - `coverage_model.f90` - Unified data model for coverage information
  - `coverage_parser.f90` - Abstract parser interface and gcov implementation
  - `coverage_statistics.f90` - Coverage metric calculations
  - `coverage_reporter.f90` - Abstract reporter interface
  - `markdown_reporter.f90` - Markdown report generation
  - `string_utils.f90` - String manipulation utilities
  - `file_utils.f90` - File system operations
  
- `app/` - Main executable entry point
  - `main.f90` - Currently placeholder, needs CLI implementation
  
- `test/` - Test suite with comprehensive coverage
  - Unit tests for all modules
  - Mock implementations for testing abstractions
  - Sample data in `test_data/` and `test_coverage_sample/`

## Coverage Analysis Workflow

1. **Input**: Process .gcov text files generated by gcov command from gfortran coverage data
2. **Processing**: Parse text-based coverage data to extract:
   - Line execution counts
   - Branch coverage information
   - Function/subroutine coverage
3. **Analysis**: Calculate coverage metrics:
   - Line coverage percentage
   - Branch coverage percentage
   - File and module-level summaries
4. **Output**: Generate Markdown reports with:
   - Coverage percentages
   - Source code annotation
   - Summary statistics

## Key Implementation Notes

- Coverage data uses .gcov text format generated by gcov command from gfortran coverage files
- The tool should handle both absolute and relative paths in coverage data
- Markdown output should be readable both as plain text and when rendered
- Focus on MVP features: basic line coverage with clear percentage reporting

## Build Strategy

### Main Project
The main fortcov project uses **Fortran Package Manager (FPM)** for all operations:
- `fpm build` - Compile the library and application
- `fpm test` - Run unit tests  
- `fpm run` - Execute the fortcov application
- `fpm build --flag "-fprofile-arcs -ftest-coverage"` - Build with coverage instrumentation

### Integration Tests
Integration tests use a **hybrid approach** for maximum flexibility:
- **FPM-based fixtures**: Test fixtures with `fpm.toml` files use FPM for consistent builds
- **Legacy fixtures**: Older fixtures without `fpm.toml` use direct gfortran compilation
- **Auto-detection**: Test runner automatically detects which approach to use per fixture

### Rationale
- **Main project**: FPM provides consistent builds, dependency management, and cross-platform compatibility
- **Integration fixtures**: Hybrid approach allows testing various real-world scenarios:
  - Projects using FPM (modern Fortran projects)
  - Projects using traditional Makefiles/direct compilation (legacy codebases)
  - Different compiler flag combinations and build structures
- **System comparison**: Makefile uses FPM for fortcov but external tools (lcov, pycobertura) use their native approaches for accurate comparison

### Coverage File Locations
- **FPM builds**: Coverage data files (.gcno/.gcda) are processed by gcov to generate .gcov text files
- **Direct compilation**: Generated .gcov files appear in working directory or alongside source files
- **Detection**: Integration tests automatically locate .gcov files regardless of build method

## Testing Strategy

Tests should verify:
1. Correct parsing of coverage data files
2. Accurate calculation of coverage percentages
3. Proper Markdown formatting in reports
4. Handling of edge cases (no coverage data, 100% coverage, uncovered files)
5. **Build approach compatibility**: Ensure fortcov works with both FPM and traditional builds

## Coverage Format Standards

The tool should support intermediate standardized formats for flexibility:
- **Cobertura XML**: Widely supported format, good for CI/CD integration
- **LCOV info format**: Text-based, human-readable format
- Decision on unified internal format to be made based on:
  - Ease of diff generation
  - Tool ecosystem compatibility
  - Multi-compiler support requirements

## Multi-Compiler Support

While initially targeting gfortran, the architecture should accommodate:
- **Intel Fortran Compiler (ifort/ifx)**: Different coverage data format
- **Flang (LLVM-based)**: May use LLVM coverage formats
- Design with abstraction layer for coverage data parsing to enable future compiler support

## Diff Functionality

Future requirement for coverage diff reports:
- Compare coverage between commits/branches
- Show coverage changes (improved/degraded)
- Highlight newly covered/uncovered lines
- Summary statistics of coverage delta

## Development References

Study (but do not copy) the approaches in:
- gcovr: Python-based coverage reporter with extensive features
- lcov: Perl-based coverage tool, standard in many projects
- pycobertura (available in external/): Python library for Cobertura XML manipulation and diff generation

Focus on understanding:
- How they parse various coverage data formats
- Report generation patterns
- Coverage metric calculations
- Diff algorithms for coverage comparison